#!/usr/bin/env bash
# Clean image script
# -------------------------------------------------
# Supports two modes:
#   cleanimg remote <server>   - Run cleaning commands via SSH on remote server
#   cleanimg path <directory>  - Run cleaning commands on a mounted directory
# -------------------------------------------------
# Operations performed:
# 1. Remove Pacman keys & keyring
# 2. Install a key‑initialisation systemd service
# 3. Delete any DHCP lease files (/run/*lease*)
# 4. Remove machine‑id files (/etc/machine-id, /run/machine-id)
# -------------------------------------------------

set -euo pipefail

# ---------- Root check ----------
if [[ $EUID -ne 0 ]]; then
    echo "Error: this script must be run as root." >&2
    exit 1
fi

# ---------- Input validation ----------
if [[ $# -ne 2 ]]; then
    echo "Usage: $0 [remote|path] <server|directory>" >&2
    echo "  remote: run cleaning commands via SSH on remote server" >&2
    echo "  path:   run cleaning commands on a mounted directory" >&2
    exit 1
fi

MODE="$1"
TARGET="$2"

# Validate mode
if [[ "$MODE" != "remote" && "$MODE" != "path" ]]; then
    echo "Error: MODE must be 'remote' or 'path'" >&2
    exit 1
fi

# Validate target
if [[ "$MODE" == "path" ]]; then
    if [[ ! -d "$TARGET" ]]; then
        echo "Error: directory not found: $TARGET" >&2
        exit 1
    fi
    MNT="$TARGET"
    echo "Using mounted directory: $MNT"
elif [[ "$MODE" == "remote" ]]; then
    echo "Using remote server: $TARGET"
fi

# ---------- Define cleaning operations ----------
run_cleaning() {
    local target_root="$1"
    
    # Remove Pacman keys & keyring
    echo "Removing Pacman keys and keyring..."
    rm -rf "${target_root}/var/lib/pacman/local"
    rm -rf "${target_root}/etc/pacman.d/gnupg"
    
    # Install key‑initialisation systemd service
    echo "Installing Pacman key initialization systemd unit..."
    local unit_path="${target_root}/etc/systemd/system/pacman-key-init.service"
    mkdir -p "${target_root}/etc/systemd/system"
    cat > "$unit_path" <<'UNIT_EOF'
[Unit]
Description=Initialize Pacman keyring (run once)
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/bin/pacman-key --init
ExecStart=/usr/bin/pacman-key --populate archlinux
ExecStart=/usr/bin/pacman -Sy
# Disable the unit after a successful run so it never starts again
ExecStartPost=/usr/bin/systemctl disable --now pacman-key-init.service

[Install]
WantedBy=multi-user.target
UNIT_EOF
    
    # Enable the unit for the first boot
    mkdir -p "${target_root}/etc/systemd/system/multi-user.target.wants"
    ln -sf /etc/systemd/system/pacman-key-init.service \
            "${target_root}/etc/systemd/system/multi-user.target.wants/pacman-key-init.service"
    
    echo "Systemd unit installed and enabled at $unit_path"
    
    # Remove DHCP lease files from multiple locations
    echo "Removing DHCP lease files..."
    find "${target_root}/run" -type f -name '*lease*' -exec rm -f {} + || true
    find "${target_root}/var/lib/dhcp" -type f -name '*lease*' -exec rm -f {} + || true
    rm -rf "${target_root}/var/lib/NetworkManager/"* || true
    
    # Remove machine-id files
    echo "Removing machine-id files..."
    rm -f "${target_root}/etc/machine-id" "${target_root}/run/machine-id"
}

run_remote_cleaning() {
    local server="$1"
    
    echo "Running cleaning commands on remote server: $server"
    
    # Run cleaning commands via SSH
    ssh "$server" bash -s <<'SSH_EOF'
#!/bin/bash
set -euo pipefail

# Remove Pacman keys & keyring
echo "Removing Pacman keys and keyring..."
sudo rm -rf /var/lib/pacman/local
sudo rm -rf /etc/pacman.d/gnupg

# Install key‑initialisation systemd service
echo "Installing Pacman key initialization systemd unit..."
sudo tee /etc/systemd/system/pacman-key-init.service > /dev/null <<'UNIT_EOF'
[Unit]
Description=Initialize Pacman keyring (run once)
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/bin/pacman-key --init
ExecStart=/usr/bin/pacman-key --populate archlinux
ExecStart=/usr/bin/pacman -Sy
# Disable the unit after a successful run so it never starts again
ExecStartPost=/usr/bin/systemctl disable --now pacman-key-init.service

[Install]
WantedBy=multi-user.target
UNIT_EOF

# Enable the unit for the first boot
sudo mkdir -p /etc/systemd/system/multi-user.target.wants
sudo ln -sf /etc/systemd/system/pacman-key-init.service \
            /etc/systemd/system/multi-user.target.wants/pacman-key-init.service

echo "Systemd unit installed and enabled"

# Remove DHCP lease files from multiple locations
echo "Removing DHCP lease files..."
sudo find /run -type f -name '*lease*' -exec rm -f {} + || true
sudo find /var/lib/dhcp -type f -name '*lease*' -exec rm -f {} + || true
sudo rm -rf /var/lib/NetworkManager/* || true

# Remove machine-id files
echo "Removing machine-id files..."
sudo rm -f /etc/machine-id /run/machine-id

echo "Remote cleaning complete"
SSH_EOF
}

# ---------- Execute based on mode ----------
if [[ "$MODE" == "path" ]]; then
    run_cleaning "$MNT"
    echo "Cleaning complete for directory: $MNT"
elif [[ "$MODE" == "remote" ]]; then
    run_remote_cleaning "$TARGET"
fi

echo "Done"
sync
echo "Modifications complete."

# ---------- 12. Unmount & detach (handled by trap) ----------
umount "$MNT"
losetup -d "$LOOPDEV"
echo "Unmounted and detached loop device."

